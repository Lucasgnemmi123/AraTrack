{% extends "layout.html" %}

{% block title %}Editar Viaje - AraTrack{% endblock %}

{% block content %}
<div class="w-[92%] mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-900 flex items-center">
            <i class="bi bi-pencil-square text-blue-500 mr-3"></i>
            Editar Viaje Existente
        </h2>
    </div>

    <!-- PASO 1: Buscar Número de Viaje -->
    <div id="paso1-buscar" class="bg-gradient-to-br from-blue-50 to-white rounded-xl shadow-lg p-6 mb-6 border-2 border-blue-200">
        <h3 class="text-xl font-bold text-blue-600 mb-4 flex items-center">
            <span class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">1</span>
            Buscar Viaje
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="buscar_numero_viaje" class="block text-sm font-medium text-gray-700 mb-2">Número de Viaje <span class="text-red-500">*</span></label>
                <input type="text" id="buscar_numero_viaje" required placeholder="Ej: 100" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg">
            </div>
            <div class="flex items-end">
                <button type="button" onclick="buscarCentrosCosto()" class="w-full px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition-colors shadow-md flex items-center justify-center">
                    <i class="bi bi-search mr-2"></i>Buscar Centros
                </button>
            </div>
        </div>
        <div id="mensaje-busqueda" class="mt-4"></div>
    </div>

    <!-- PASO 2: Seleccionar Centro de Costo (oculto inicialmente) -->
    <div id="paso2-centros" style="display: none;" class="bg-gradient-to-br from-purple-50 to-white rounded-xl shadow-lg p-6 mb-6 border-2 border-purple-200">
        <h3 class="text-xl font-bold text-purple-600 mb-4 flex items-center">
            <span class="bg-purple-600 text-white w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">2</span>
            Seleccionar Centro de Costo
        </h3>
        <div>
            <label for="select_centro_costo" class="block text-sm font-medium text-gray-700 mb-2">Centro de Costo <span class="text-red-500">*</span></label>
            <select id="select_centro_costo" onchange="cargarViajeCompleto()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-lg">
                <option value="">Seleccionar centro de costo...</option>
            </select>
        </div>
    </div>

    <!-- PASO 3: Formulario Completo de Edición (oculto inicialmente) -->
    <div id="paso3-formulario" style="display: none;" class="bg-gradient-to-br from-green-50 to-white rounded-xl shadow-lg p-6 mb-6 border-2 border-green-200">
        <h3 class="text-xl font-bold text-green-600 mb-4 flex items-center">
            <span class="bg-green-600 text-white w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">3</span>
            Editar Datos del Viaje
        </h3>
        
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded-lg">
            <p class="text-sm text-gray-700">
                <strong class="text-blue-700">Viaje:</strong> <span id="info_numero_viaje" class="font-mono font-semibold"></span> | 
                <strong class="text-blue-700 ml-4"><i class="bi bi-building mr-1"></i>Centro:</strong> <span id="info_centro_costo" class="font-semibold"></span>
            </p>
        </div>

        <form id="formEditar">
            <!-- FORMULARIO SE LLENA DINÁMICAMENTE -->
        </form>

        <div id="mensaje-resultado-edit" class="mensaje" style="display: none; margin-top: 1rem;"></div>
    </div>
</div>

<script>
let numeroViajeActual = '';
let centrosCostoDisponibles = [];
let contadorComidasEdit = 0;

// PASO 1: Buscar centros de costo
function buscarCentrosCosto() {
    const numeroViaje = document.getElementById('buscar_numero_viaje').value.trim();
    const mensajeBusqueda = document.getElementById('mensaje-busqueda');
    
    if (!numeroViaje) {
        mensajeBusqueda.innerHTML = '<div class="bg-red-50 border-l-4 border-red-500 p-3 rounded"><p class="text-red-700 text-sm">Ingresa un número de viaje</p></div>';
        return;
    }
    
    numeroViajeActual = numeroViaje;
    mensajeBusqueda.innerHTML = '<div class="bg-gray-50 border-l-4 border-gray-400 p-3 rounded"><p class="text-gray-700 text-sm flex items-center"><i class="bi bi-hourglass-split mr-2 animate-spin"></i>Buscando centros de costo...</p></div>';
    
    fetch(`/api/buscar-centros-costo/${numeroViaje}`)
        .then(response => response.json())
        .then(centros => {
            if (centros && centros.length > 0) {
                centrosCostoDisponibles = centros;
                mostrarCentrosCosto(centros);
                mensajeBusqueda.innerHTML = `<div class="bg-green-50 border-l-4 border-green-500 p-3 rounded"><p class="text-green-700 text-sm flex items-center"><i class="bi bi-check-circle mr-2"></i>Se encontraron ${centros.length} centro(s) de costo</p></div>`;
            } else {
                mensajeBusqueda.innerHTML = '<div class="bg-red-50 border-l-4 border-red-500 p-3 rounded"><p class="text-red-700 text-sm flex items-center"><i class="bi bi-exclamation-circle mr-2"></i>No se encontraron registros para este viaje</p></div>';
                document.getElementById('paso2-centros').style.display = 'none';
                document.getElementById('paso3-formulario').style.display = 'none';
            }
        })
        .catch(error => {
            mensajeBusqueda.innerHTML = '<div class="bg-red-50 border-l-4 border-red-500 p-3 rounded"><p class="text-red-700 text-sm">Error al buscar: ' + error.message + '</p></div>';
        });
}

// PASO 2: Mostrar centros disponibles
function mostrarCentrosCosto(centros) {
    const select = document.getElementById('select_centro_costo');
    select.innerHTML = '<option value="">Seleccionar centro de costo...</option>';
    
    centros.forEach(centro => {
        const option = document.createElement('option');
        option.value = centro.codigo;
        option.textContent = `${centro.codigo} - ${centro.casino}`;
        select.appendChild(option);
    });
    
    document.getElementById('paso2-centros').style.display = 'block';
    document.getElementById('paso3-formulario').style.display = 'none';
    document.getElementById('paso2-centros').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// PASO 3: Cargar viaje completo
function cargarViajeCompleto() {
    const centroCosto = document.getElementById('select_centro_costo').value;
    
    if (!centroCosto) {
        document.getElementById('paso3-formulario').style.display = 'none';
        return;
    }
    
    fetch('/api/buscar-viaje', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            numero_viaje: numeroViajeActual,
            centro_costo: centroCosto
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            llenarFormulario(result.viaje, result.comidas);
            document.getElementById('paso3-formulario').style.display = 'block';
            setTimeout(() => {
                document.getElementById('paso3-formulario').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        } else {
            alert('No se pudo cargar el viaje');
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function llenarFormulario(viaje, comidas) {
    document.getElementById('info_numero_viaje').textContent = viaje.numero_viaje || '';
    document.getElementById('info_centro_costo').textContent = viaje.costo_codigo || '';
    
    const form = document.getElementById('formEditar');
    form.innerHTML = `
        <input type="hidden" id="edit_numero_viaje" value="${viaje.numero_viaje || ''}">
        <input type="hidden" id="edit_centro_costo" value="${viaje.costo_codigo || ''}">
        
        <!-- INFORMACIÓN PRINCIPAL -->
        <div class="bg-white rounded-xl shadow-lg mb-2 overflow-hidden">
            <div class="bg-gradient-to-r from-red-500 to-red-600 px-4 py-2">
                <h5 class="text-lg font-semibold text-white flex items-center">
                    <i class="bi bi-info-circle mr-2"></i>Información Principal del Viaje
                </h5>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Número de Viaje</label>
                        <input type="text" value="${viaje.numero_viaje || ''}" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Centro de Costo</label>
                        <input type="text" value="${viaje.costo_codigo || ''}" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                    </div>
                    <div>
                        <label for="edit_fecha" class="block text-sm font-medium text-gray-700 mb-1">Fecha <span class="text-red-500">*</span></label>
                        <input type="date" id="edit_fecha" value="${viaje.fecha || ''}" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                    </div>
                </div>
            </div>
        </div>

        <!-- CASINO Y RUTA -->
        <div class="bg-white rounded-xl shadow-lg mb-2 overflow-hidden">
            <div class="bg-gradient-to-r from-teal-500 to-teal-600 px-4 py-2">
                <h5 class="text-lg font-semibold text-white flex items-center">
                    <i class="bi bi-building mr-2"></i>Casino y Ruta
                </h5>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label for="edit_casino" class="block text-sm font-medium text-gray-700 mb-1">Casino</label>
                        <input type="text" id="edit_casino" value="${viaje.casino || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="edit_ruta" class="block text-sm font-medium text-gray-700 mb-1">Ruta</label>
                        <input type="text" id="edit_ruta" value="${viaje.ruta || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
            </div>
        </div>

        <!-- DATOS DEL CAMIÓN -->
        <div class="bg-white rounded-xl shadow-lg mb-2 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-4 py-2">
                <h5 class="text-lg font-semibold text-white flex items-center">
                    <i class="bi bi-truck mr-2"></i>Datos del Camión
                </h5>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label for="edit_tipo_camion" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Camión</label>
                        <input type="text" id="edit_tipo_camion" value="${viaje.tipo_camion || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="edit_patente_camion" class="block text-sm font-medium text-gray-700 mb-1">Patente Camión <span class="text-red-500">*</span></label>
                        <input type="text" id="edit_patente_camion" value="${viaje.patente_camion || ''}" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent uppercase">
                    </div>
                    <div>
                        <label for="edit_patente_semi" class="block text-sm font-medium text-gray-700 mb-1">Patente Semi</label>
                        <input type="text" id="edit_patente_semi" value="${viaje.patente_semi || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="edit_numero_rampa" class="block text-sm font-medium text-gray-700 mb-1">N° de Rampla</label>
                        <input type="text" id="edit_numero_rampa" value="${viaje.numero_rampa || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="edit_peso_camion" class="block text-sm font-medium text-gray-700 mb-1">Peso Camión</label>
                        <input type="text" id="edit_peso_camion" value="${viaje.peso_camion || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="edit_numero_camion" class="block text-sm font-medium text-gray-700 mb-1">N° Camión</label>
                        <input type="text" id="edit_numero_camion" value="${viaje.numero_camion || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="md:col-span-2">
                        <label for="edit_termografos_gps" class="block text-sm font-medium text-gray-700 mb-1">Termógrafos / GPS</label>
                        <input type="text" id="edit_termografos_gps" value="${viaje.termografos_gps || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
            </div>
        </div>

        <!-- DATOS DEL CONDUCTOR -->
        <div class="bg-white rounded-xl shadow-lg mb-2 overflow-hidden">
            <div class="bg-gradient-to-r from-cyan-500 to-cyan-600 px-4 py-2">
                <h5 class="text-lg font-semibold text-white flex items-center">
                    <i class="bi bi-person mr-2"></i>Datos del Conductor
                </h5>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label for="edit_chofer" class="block text-sm font-medium text-gray-700 mb-1">Conductor <span class="text-red-500">*</span></label>
                        <input type="text" id="edit_chofer" value="${viaje.conductor || ''}" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="edit_celular" class="block text-sm font-medium text-gray-700 mb-1">Celular</label>
                        <input type="text" id="edit_celular" value="${viaje.celular || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="edit_rut" class="block text-sm font-medium text-gray-700 mb-1">RUT</label>
                        <input type="text" id="edit_rut" value="${viaje.rut || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
            </div>
        </div>

        <!-- HORARIOS -->
        <div class="bg-white rounded-xl shadow-lg mb-2 overflow-hidden">
            <div class="bg-gradient-to-r from-slate-500 to-slate-600 px-4 py-2">
                <h5 class="text-lg font-semibold text-white flex items-center">
                    <i class="bi bi-clock mr-2"></i>Horarios DHL
                </h5>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label for="edit_hora_llegada" class="block text-sm font-semibold text-gray-900 mb-1">⏰ Fecha y Hora Llegada DHL <span class="text-blue-600">(Click aquí)</span></label>
                        <input type="datetime-local" id="edit_hora_llegada" value="${viaje.fecha_hora_llegada_dhl || ''}" class="w-full px-5 py-4 text-lg font-medium border-2 border-blue-400 bg-blue-50 rounded-lg focus:ring-4 focus:ring-blue-500 focus:border-blue-600 hover:bg-blue-100 cursor-pointer transition-all">
                    </div>
                    <div>
                        <label for="edit_hora_salida" class="block text-sm font-semibold text-gray-900 mb-1">⏰ Fecha y Hora Salida DHL <span class="text-blue-600">(Click aquí)</span></label>
                        <input type="datetime-local" id="edit_hora_salida" value="${viaje.fecha_hora_salida_dhl || ''}" class="w-full px-5 py-4 text-lg font-medium border-2 border-blue-400 bg-blue-50 rounded-lg focus:ring-4 focus:ring-blue-500 focus:border-blue-600 hover:bg-blue-100 cursor-pointer transition-all">
                    </div>
                </div>
            </div>
        </div>

        <!-- ACTIVOS SALIDA -->
        <div class="bg-white rounded-xl shadow-lg mb-2 overflow-hidden">
            <div class="bg-gradient-to-r from-red-500 to-red-600 px-4 py-2">
                <h5 class="text-lg font-semibold text-white flex items-center">
                    <i class="bi bi-box-arrow-right mr-2"></i>Activos Salida
                </h5>
            </div>
            <div class="p-4">
                <!-- ACTIVOS -->
                <h4 class="text-md font-semibold text-gray-800 mb-2 flex items-center"><i class="bi bi-box-seam mr-2 text-red-500"></i>Activos</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                    <div>
                        <label for="edit_num_wencos" class="block text-sm font-medium text-gray-700 mb-1">N° Wencos</label>
                        <input type="number" id="edit_num_wencos" value="${viaje.num_wencos || 0}" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="edit_bin" class="block text-sm font-medium text-gray-700 mb-1">BIN</label>
                        <input type="text" id="edit_bin" value="${viaje.bin || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="edit_pallets" class="block text-sm font-medium text-gray-700 mb-1">Pallets</label>
                        <input type="number" id="edit_pallets" value="${viaje.pallets || 0}" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="edit_pallets_chep" class="block text-sm font-medium text-gray-700 mb-1">Pallets CHEP</label>
                        <input type="number" id="edit_pallets_chep" value="${viaje.pallets_chep || 0}" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="edit_pallets_pl_negro_grueso" class="block text-sm font-medium text-gray-700 mb-1">PL Negro Grueso</label>
                        <input type="text" id="edit_pallets_pl_negro_grueso" value="${viaje.pallets_pl_negro_grueso || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="edit_pallets_pl_negro_alternativo" class="block text-sm font-medium text-gray-700 mb-1">PL Negro Alt.</label>
                        <input type="text" id="edit_pallets_pl_negro_alternativo" value="${viaje.pallets_pl_negro_alternativo || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>

                <!-- PALLETS POR ÁREA -->
                <h4 class="text-md font-semibold text-gray-800 mb-2 flex items-center"><i class="bi bi-thermometer-half mr-2 text-blue-500"></i>Pallets por Área</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                    <div>
                        <label for="edit_pallets_congelado" class="block text-sm font-medium text-gray-700 mb-1">Pallets Congelado</label>
                        <input type="number" id="edit_pallets_congelado" value="${viaje.pallets_congelado || 0}" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="edit_wencos_congelado" class="block text-sm font-medium text-gray-700 mb-1">Wencos Congelado</label>
                        <input type="number" id="edit_wencos_congelado" value="${viaje.wencos_congelado || 0}" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="edit_pallets_refrigerado" class="block text-sm font-medium text-gray-700 mb-1">Pallets Refrigerado</label>
                        <input type="number" id="edit_pallets_refrigerado" value="${viaje.pallets_refrigerado || 0}" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="edit_wencos_refrigerado" class="block text-sm font-medium text-gray-700 mb-1">Wencos Refrigerado</label>
                        <input type="number" id="edit_wencos_refrigerado" value="${viaje.wencos_refrigerado || 0}" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="edit_pallets_abarrote" class="block text-sm font-medium text-gray-700 mb-1">Pallets Abarrote</label>
                        <input type="number" id="edit_pallets_abarrote" value="${viaje.pallets_abarrote || 0}" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>

                <!-- VALIDACIONES -->
                <h4 class="text-md font-semibold text-gray-800 mb-2 flex items-center"><i class="bi bi-check2-square mr-2 text-green-500"></i>Validaciones</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3 bg-gray-50 p-3 rounded-lg">
                    <label class="flex items-center space-x-2 text-sm text-gray-700 cursor-pointer hover:text-gray-900">
                        <input type="checkbox" id="edit_check_congelado" ${(viaje.check_congelado === 'X' || viaje.check_congelado === 'x' || viaje.check_congelado === '1' || viaje.check_congelado === 1) ? 'checked' : ''} class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500"> 
                        <span class="font-medium">Congelado</span>
                    </label>
                    <label class="flex items-center space-x-2 text-sm text-gray-700 cursor-pointer hover:text-gray-900">
                        <input type="checkbox" id="edit_check_refrigerado" ${(viaje.check_refrigerado === 'X' || viaje.check_refrigerado === 'x' || viaje.check_refrigerado === '1' || viaje.check_refrigerado === 1) ? 'checked' : ''} class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500"> 
                        <span class="font-medium">Refrigerado</span>
                    </label>
                    <label class="flex items-center space-x-2 text-sm text-gray-700 cursor-pointer hover:text-gray-900">
                        <input type="checkbox" id="edit_check_abarrote" ${(viaje.check_abarrote === 'X' || viaje.check_abarrote === 'x' || viaje.check_abarrote === '1' || viaje.check_abarrote === 1) ? 'checked' : ''} class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500"> 
                        <span class="font-medium">Abarrote</span>
                    </label>
                    <label class="flex items-center space-x-2 text-sm text-gray-700 cursor-pointer hover:text-gray-900">
                        <input type="checkbox" id="edit_check_implementos" ${(viaje.check_implementos === 'X' || viaje.check_implementos === 'x' || viaje.check_implementos === '1' || viaje.check_implementos === 1) ? 'checked' : ''} class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500"> 
                        <span class="font-medium">Implementos</span>
                    </label>
                    <label class="flex items-center space-x-2 text-sm text-gray-700 cursor-pointer hover:text-gray-900">
                        <input type="checkbox" id="edit_check_aseo" ${(viaje.check_aseo === 'X' || viaje.check_aseo === 'x' || viaje.check_aseo === '1' || viaje.check_aseo === 1) ? 'checked' : ''} class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500"> 
                        <span class="font-medium">Aseo</span>
                    </label>
                    <label class="flex items-center space-x-2 text-sm text-gray-700 cursor-pointer hover:text-gray-900">
                        <input type="checkbox" id="edit_check_trazabilidad" ${(viaje.check_trazabilidad === 'X' || viaje.check_trazabilidad === 'x' || viaje.check_trazabilidad === '1' || viaje.check_trazabilidad === 1) ? 'checked' : ''} class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500"> 
                        <span class="font-medium">Trazabilidad</span>
                    </label>
                    <label class="flex items-center space-x-2 text-sm text-gray-700 cursor-pointer hover:text-gray-900">
                        <input type="checkbox" id="edit_check_plataforma_wtck" ${(viaje.check_plataforma_wtck === 'X' || viaje.check_plataforma_wtck === 'x' || viaje.check_plataforma_wtck === '1' || viaje.check_plataforma_wtck === 1) ? 'checked' : ''} class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500"> 
                        <span class="font-medium">Plataforma WTCK</span>
                    </label>
                    <label class="flex items-center space-x-2 text-sm text-gray-700 cursor-pointer hover:text-gray-900">
                        <input type="checkbox" id="edit_check_env_correo_wtck" ${(viaje.check_env_correo_wtck === 'X' || viaje.check_env_correo_wtck === 'x' || viaje.check_env_correo_wtck === '1' || viaje.check_env_correo_wtck === 1) ? 'checked' : ''} class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500"> 
                        <span class="font-medium">Envío Correo WTCK</span>
                    </label>
                    <label class="flex items-center space-x-2 text-sm text-gray-700 cursor-pointer hover:text-gray-900">
                        <input type="checkbox" id="edit_check_revision_planilla_despacho" ${(viaje.check_revision_planilla_despacho === 'X' || viaje.check_revision_planilla_despacho === 'x' || viaje.check_revision_planilla_despacho === '1' || viaje.check_revision_planilla_despacho === 1) ? 'checked' : ''} class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500"> 
                        <span class="font-medium">Revisión Planilla Despacho</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- GUÍAS -->
        <div class="bg-white rounded-xl shadow-lg mb-2 overflow-hidden">
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 px-4 py-2">
                <h5 class="text-lg font-semibold text-white flex items-center">
                    <i class="bi bi-file-text mr-2"></i>Guías
                </h5>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                    ${[1,2,3].map(i => `
                        <div>
                            <label for="edit_guia_${i}" class="block text-sm font-medium text-gray-700 mb-1">Guía ${i}</label>
                            <input type="text" id="edit_guia_${i}" value="${viaje[`guia_${i}`] || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" maxlength="30">
                        </div>
                    `).join('')}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                    ${[4,5,6].map(i => `
                        <div>
                            <label for="edit_guia_${i}" class="block text-sm font-medium text-gray-700 mb-1">Guía ${i}</label>
                            <input type="text" id="edit_guia_${i}" value="${viaje[`guia_${i}`] || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" maxlength="30">
                        </div>
                    `).join('')}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                    ${[7,8,9].map(i => `
                        <div>
                            <label for="edit_guia_${i}" class="block text-sm font-medium text-gray-700 mb-1">Guía ${i}</label>
                            <input type="text" id="edit_guia_${i}" value="${viaje[`guia_${i}`] || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" maxlength="30">
                        </div>
                    `).join('')}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                    ${[10,11,12].map(i => `
                        <div>
                            <label for="edit_guia_${i}" class="block text-sm font-medium text-gray-700 mb-1">Guía ${i}</label>
                            <input type="text" id="edit_guia_${i}" value="${viaje[`guia_${i}`] || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" maxlength="30">
                        </div>
                    `).join('')}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                    ${[13,14].map(i => `
                        <div>
                            <label for="edit_guia_${i}" class="block text-sm font-medium text-gray-700 mb-1">Guía ${i}</label>
                            <input type="text" id="edit_guia_${i}" value="${viaje[`guia_${i}`] || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" maxlength="30">
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>

        <!-- SELLOS -->
        <div class="bg-white rounded-xl shadow-lg mb-2 overflow-hidden">
            <div class="bg-gradient-to-r from-orange-500 to-orange-600 px-4 py-2">
                <h5 class="text-lg font-semibold text-white flex items-center">
                    <i class="bi bi-shield-check mr-2"></i>Sellos
                </h5>
            </div>
            <div class="p-4">
                <h4 class="text-md font-semibold text-gray-800 mb-3 flex items-center"><i class="bi bi-caret-right-fill text-blue-500 mr-2"></i>Salida</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                    ${[1,2,3].map(i => `
                        <div>
                            <label for="edit_sello_salida_${i}p" class="block text-sm font-medium text-gray-700 mb-1">Sello ${i}P</label>
                            <input type="text" id="edit_sello_salida_${i}p" value="${viaje[`sello_salida_${i}p`] || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" maxlength="30">
                        </div>
                    `).join('')}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                    ${[4,5].map(i => `
                        <div>
                            <label for="edit_sello_salida_${i}p" class="block text-sm font-medium text-gray-700 mb-1">Sello ${i}P</label>
                            <input type="text" id="edit_sello_salida_${i}p" value="${viaje[`sello_salida_${i}p`] || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" maxlength="30">
                        </div>
                    `).join('')}
                </div>

                <h4 class="text-md font-semibold text-gray-800 mb-3 mt-4 flex items-center"><i class="bi bi-caret-right-fill text-blue-500 mr-2"></i>Retorno</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                    ${[1,2,3].map(i => `
                        <div>
                            <label for="edit_sello_retorno_${i}p" class="block text-sm font-medium text-gray-700 mb-1">Sello ${i}P</label>
                            <input type="text" id="edit_sello_retorno_${i}p" value="${viaje[`sello_retorno_${i}p`] || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" maxlength="30">
                        </div>
                    `).join('')}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                    ${[4,5].map(i => `
                        <div>
                            <label for="edit_sello_retorno_${i}p" class="block text-sm font-medium text-gray-700 mb-1">Sello ${i}P</label>
                            <input type="text" id="edit_sello_retorno_${i}p" value="${viaje[`sello_retorno_${i}p`] || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" maxlength="30">
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>

        <!-- CONTROLES Y CERTIFICACIONES -->
        <div class="bg-white rounded-xl shadow-lg mb-2 overflow-hidden">
            <div class="bg-gradient-to-r from-indigo-500 to-indigo-600 px-4 py-2">
                <h5 class="text-lg font-semibold text-white flex items-center">
                    <i class="bi bi-clipboard-check mr-2"></i>Controles y Certificaciones
                </h5>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                    <div>
                        <label for="edit_numero_certificado_fumigacion" class="block text-sm font-medium text-gray-700 mb-1">Número Certificado Fumigación</label>
                        <input type="text" id="edit_numero_certificado_fumigacion" value="${viaje.numero_certificado_fumigacion || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" maxlength="20">
                    </div>
                    <div>
                        <label for="edit_revision_limpieza_camion_acciones" class="block text-sm font-medium text-gray-700 mb-1">Revisión Limpieza Camión</label>
                        <input type="text" id="edit_revision_limpieza_camion_acciones" value="${viaje.revision_limpieza_camion_acciones || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" maxlength="20">
                    </div>
                </div>

                <div>
                    <label for="edit_administrativo_responsable" class="block text-sm font-medium text-gray-700 mb-1">Administrativo Responsable</label>
                    <select id="edit_administrativo_responsable" class="select2 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Seleccione un administrativo...</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="my-8 border-t-2 border-gray-200"></div>

        <!-- COMIDAS PREPARADAS -->
        <div class="bg-white rounded-xl shadow-lg mb-2 overflow-hidden">
            <div class="bg-gradient-to-r from-green-500 to-green-600 px-6 py-4 flex justify-between items-center">
                <h5 class="text-lg font-semibold text-white flex items-center">
                    <i class="bi bi-egg-fried mr-2"></i>Despacho Comidas Preparadas
                </h5>
                <button type="button" class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition-colors" onclick="agregarComidaEdit()">+ Agregar Comida</button>
            </div>
            <div class="p-4">
                <p class="text-gray-600 mb-4">Las comidas están asociadas al centro de costo ${viaje.costo_codigo || ''}.</p>
                <div id="edit-comidas-container">
                    ${comidas.map((comida, index) => `
                        <div class="comida-item-edit bg-gradient-to-r from-green-50 to-white p-4 mb-3 border-l-4 border-green-500 rounded-lg shadow-sm" id="comida-edit-${index}">
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-start">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Guía Comida</label>
                                    <input type="text" class="comida_guia w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${comida.guia_comida || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                                    <input type="text" class="comida_descripcion w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${comida.descripcion || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Kilos</label>
                                    <input type="number" class="comida_kilo w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${comida.kilo || 0}" step="0.01" min="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Bultos</label>
                                    <input type="number" class="comida_bultos w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${comida.bultos || 0}" min="0">
                                </div>
                                <div class="flex items-end">
                                    <button type="button" onclick="eliminarComidaEdit(${index})" class="w-full px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors flex items-center justify-center">
                                        <i class="bi bi-trash mr-1"></i>Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>

        <div class="flex gap-4 mt-8 justify-end">
            <button type="submit" class="w-full md:w-auto px-8 py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold rounded-lg transition-all duration-200 text-lg shadow-lg flex items-center justify-center">
                <i class="bi bi-save mr-2"></i>Actualizar Viaje
            </button>
            <button type="button" onclick="confirmarEliminar()" class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition-colors shadow-md flex items-center">
                <i class="bi bi-trash mr-2"></i>Eliminar
            </button>
            <button type="button" onclick="cancelarEdicion()" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors flex items-center">
                <i class="bi bi-x-circle mr-2"></i>Cancelar
            </button>
        </div>
    `;
    
    contadorComidasEdit = comidas.length;
    document.getElementById('formEditar').addEventListener('submit', actualizarViaje);
    
    // Cargar administrativos en el select2
    cargarAdministrativosEdicion(viaje.administrativo_responsable || '');
}

function agregarComidaEdit() {
    // Limitar a 20 comidas máximo
    if (contadorComidasEdit >= 20) {
        alert('Máximo 20 comidas permitidas');
        return;
    }
    
    const container = document.getElementById('edit-comidas-container');
    const index = contadorComidasEdit++;
    
    container.insertAdjacentHTML('beforeend', `
        <div class="comida-item-edit bg-gradient-to-r from-green-50 to-white p-4 mb-3 border-l-4 border-green-500 rounded-lg shadow-sm" id="comida-edit-${index}">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-start">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Guía Comida</label>
                    <input type="text" class="comida_guia w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                    <input type="text" class="comida_descripcion w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kilos</label>
                    <input type="number" class="comida_kilo w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="0" step="0.01" min="0">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Bultos</label>
                    <input type="number" class="comida_bultos w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="0" min="0">
                </div>
                <div class="flex items-end">
                    <button type="button" onclick="eliminarComidaEdit(${index})" class="w-full px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors flex items-center justify-center">
                        <i class="bi bi-trash mr-1"></i>Eliminar
                    </button>
                </div>
            </div>
        </div>
    `);
}

function eliminarComidaEdit(index) {
    const elemento = document.getElementById(`comida-edit-${index}`);
    if (elemento && confirm('¿Eliminar esta comida?')) {
        elemento.remove();
    }
}

function actualizarViaje(e) {
    e.preventDefault();
    
    const data = {
        numero_viaje: document.getElementById('edit_numero_viaje').value,
        centro_costo: document.getElementById('edit_centro_costo').value,
        fecha: document.getElementById('edit_fecha').value,
        casino: document.getElementById('edit_casino').value,
        ruta: document.getElementById('edit_ruta').value,
        tipo_camion: document.getElementById('edit_tipo_camion').value,
        patente_camion: document.getElementById('edit_patente_camion').value,
        patente_semi: document.getElementById('edit_patente_semi').value,
        numero_rampa: document.getElementById('edit_numero_rampa').value,
        peso_camion: document.getElementById('edit_peso_camion').value,
        numero_camion: document.getElementById('edit_numero_camion').value,
        termografos_gps: document.getElementById('edit_termografos_gps').value,
        chofer: document.getElementById('edit_chofer').value,
        celular: document.getElementById('edit_celular').value,
        rut: document.getElementById('edit_rut').value,
        hora_salida: document.getElementById('edit_hora_salida').value,
        hora_llegada: document.getElementById('edit_hora_llegada').value,
        num_wencos: document.getElementById('edit_num_wencos').value,
        bin: document.getElementById('edit_bin').value,
        pallets: document.getElementById('edit_pallets').value,
        pallets_chep: document.getElementById('edit_pallets_chep').value,
        pallets_pl_negro_grueso: document.getElementById('edit_pallets_pl_negro_grueso').value,
        pallets_pl_negro_alternativo: document.getElementById('edit_pallets_pl_negro_alternativo').value,
        pallets_congelado: document.getElementById('edit_pallets_congelado').value,
        wencos_congelado: document.getElementById('edit_wencos_congelado').value,
        check_congelado: document.getElementById('edit_check_congelado').checked ? 'X' : '',
        pallets_refrigerado: document.getElementById('edit_pallets_refrigerado').value,
        wencos_refrigerado: document.getElementById('edit_wencos_refrigerado').value,
        check_refrigerado: document.getElementById('edit_check_refrigerado').checked ? 'X' : '',
        pallets_abarrote: document.getElementById('edit_pallets_abarrote').value,

        check_abarrote: document.getElementById('edit_check_abarrote').checked ? 'X' : '',
        check_implementos: document.getElementById('edit_check_implementos').checked ? 'X' : '',
        check_aseo: document.getElementById('edit_check_aseo').checked ? 'X' : '',
        check_trazabilidad: document.getElementById('edit_check_trazabilidad').checked ? 'X' : '',
        check_plataforma_wtck: document.getElementById('edit_check_plataforma_wtck').checked ? 'X' : '',
        check_env_correo_wtck: document.getElementById('edit_check_env_correo_wtck').checked ? 'X' : '',
        check_revision_planilla_despacho: document.getElementById('edit_check_revision_planilla_despacho').checked ? 'X' : '',
        numero_certificado_fumigacion: document.getElementById('edit_numero_certificado_fumigacion').value,
        revision_limpieza_camion_acciones: document.getElementById('edit_revision_limpieza_camion_acciones').value,
        administrativo_responsable: document.getElementById('edit_administrativo_responsable').value,
        comidas: []
    };
    
    for (let i = 1; i <= 14; i++) {
        data[`guia_${i}`] = document.getElementById(`edit_guia_${i}`).value;
    }
    
    for (let i = 1; i <= 5; i++) {
        data[`sello_salida_${i}p`] = document.getElementById(`edit_sello_salida_${i}p`).value;
        data[`sello_retorno_${i}p`] = document.getElementById(`edit_sello_retorno_${i}p`).value;
    }
    
    const comidasItems = document.querySelectorAll('.comida-item-edit');
    comidasItems.forEach(item => {
        const descripcion = item.querySelector('.comida_descripcion').value.trim();
        if (descripcion) {
            data.comidas.push({
                guia_comida: item.querySelector('.comida_guia').value,
                descripcion: descripcion,
                kilo: parseFloat(item.querySelector('.comida_kilo').value) || 0,
                bultos: parseInt(item.querySelector('.comida_bultos').value) || 0
            });
        }
    });
    
    fetch('/api/actualizar-viaje', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        const mensaje = document.getElementById('mensaje-resultado-edit');
        mensaje.style.display = 'block';
        
        if (result.success) {
            mensaje.className = 'mensaje mensaje-exito';
            mensaje.textContent = '' + result.message;
            setTimeout(() => mensaje.style.display = 'none', 3000);
        } else {
            mensaje.className = 'mensaje mensaje-error';
            mensaje.textContent = 'Error: ' + result.message;
        }
        
        mensaje.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    })
    .catch(error => {
        const mensaje = document.getElementById('mensaje-resultado-edit');
        mensaje.style.display = 'block';
        mensaje.className = 'mensaje mensaje-error';
        mensaje.textContent = 'Error: ' + error.message;
    });
}

function confirmarEliminar() {
    if (confirm('¿Eliminar este viaje y todas sus comidas? No se puede deshacer.')) {
        fetch('/api/eliminar-viaje', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                numero_viaje: document.getElementById('edit_numero_viaje').value,
                centro_costo: document.getElementById('edit_centro_costo').value
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Viaje eliminado');
                cancelarEdicion();
            } else {
                alert('Error: ' + result.message);
            }
        })
        .catch(error => alert('Error: ' + error.message));
    }
}

function cancelarEdicion() {
    document.getElementById('buscar_numero_viaje').value = '';
    document.getElementById('paso2-centros').style.display = 'none';
    document.getElementById('paso3-formulario').style.display = 'none';
    document.getElementById('mensaje-busqueda').innerHTML = '';
    document.getElementById('mensaje-resultado-edit').style.display = 'none';
    document.getElementById('paso1-buscar').scrollIntoView({ behavior: 'smooth' });
}

document.getElementById('buscar_numero_viaje').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        buscarCentrosCosto();
    }
});

// Cargar administrativos en el select2 del formulario de edición
function cargarAdministrativosEdicion(valorActual) {
    fetch('/api/listar-administrativos')
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            const select = $('#edit_administrativo_responsable');
            select.empty();
            select.append('<option value="">Seleccione un administrativo...</option>');
            result.administrativos.forEach(admin => {
                const selected = admin === valorActual ? 'selected' : '';
                select.append(`<option value="${admin}" ${selected}>${admin}</option>`);
            });
            // Inicializar Select2 después de cargar las opciones
            select.select2({
                placeholder: 'Buscar administrativo...',
                allowClear: true,
                language: {
                    noResults: function() {
                        return "No se encontraron resultados";
                    },
                    searching: function() {
                        return "Buscando...";
                    }
                }
            });
        }
    })
    .catch(error => console.error('Error cargando administrativos:', error));
}
</script>
{% endblock %}
